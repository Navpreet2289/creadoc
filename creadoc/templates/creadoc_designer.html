<!DOCTYPE html>
<html>
<head>
    <title>Дизайнер отчетов</title>
    <meta charset="utf-8" />
    <link href="/static/css/demo.css" rel="stylesheet">
    <link href="/static/css/stimulsoft.viewer.office2013.css" rel="stylesheet">
    <link href="/static/css/stimulsoft.designer.office2013.white.blue.css" rel="stylesheet">
    <script src="/static/scripts/stimulsoft.reports.js" type="text/javascript"></script>
    <script src="/static/scripts/stimulsoft.viewer.js" type="text/javascript"></script>
    <script src="/static/scripts/stimulsoft.designer.js" type="text/javascript"></script>
    <script src="/static/scripts/jquery-1.12.1.min.js" type="text/javascript"></script>
    <script>
        var report;

        /**
         * Формирование дизайнера отчета
         */
        function createDesigner() {
            // Параметры дизайнера отчетов
            var options = new Stimulsoft.Designer.StiDesignerOptions();
            options.appearance.fullScreenMode = true;
            options.appearance.showSaveDialog = false;

            options.toolbar.showFileMenu = false;
            options.toolbar.showAboutButton = false;

            // Формирование экземпляра дизайнера
            var designer = new Stimulsoft.Designer.StiDesigner(options, "StiDesigner", false);

            // Формируем экземпляр отчета
            report = new Stimulsoft.Report.StiReport();

            // Загружаем шаблон отчета
            var templatePath = "{{ template_url | safe }}";

            try {
                report.loadFile(templatePath);
            } catch (error) {
                alert("Не удалось загрузить шаблон " +
                        templatePath +
                        ", возможно он отсутствует.");

                return;
            }

            // Привязка переменных к шаблону
            {% for variable in variables %}
            report.dictionary.variables.add(
                new Stimulsoft.Report.Dictionary.StiVariable(
                    // Категория
                    '{{ variable.category }}',
                    // Наименование
                    '{{ variable.name }}',
                    // Псевдоним
                    '{{ variable.name }}',
                    // Описание
                    '{{ variable.description }}',
                    // Тип
                    String,
                    // Значение
                    '{{ variable.value }}'
                )
            );
            {% endfor %}

            // Привязка источников данных к шаблону
            report.dictionary.databases.clear();

{#            {% for source in sources %}#}
{#            var dataSet = new Stimulsoft.System.Data.DataSet('{{ source.name }}');#}
{#            // TODO: Неоптимальная логика#}
{#            dataSet.readJsonFile('{{ source.url }}');#}
{#            report.regData(dataSet.dataSetName, "", dataSet);#}
{#            {% endfor %}#}
            report.dictionary.synchronize();

            // Связывание шаблона и дизайнера
            designer.report = report;
            // Рендерим дизайнер в элемент с указанным идентификатором
            designer.renderHtml("designerContent");
        }

        // Обработка логики сохранения шаблона
        window.addEventListener('getTemplate', function(e) {
            if (report) {
                var template = report.saveToJsonString();
                e.detail.callback(template);
            }
        });

        window.onload = function() {
            // Загружаем файл локализации и устанавливаем его по умолчанию
            Stimulsoft.Base.Localization.StiLocalization.setLocalizationFile("/static/local/ru.xml", true);

            createDesigner();
        };
    </script>
</head>
<body>
    <div id="designerContent"></div>
</body>
</html>